---
- name: copy traefik configuration
  template:
    src: traefik.toml.j2
    dest: /srv/traefik.toml

- name: create acme dir storage
  file:
    path: /srv/acme
    state: directory


- name: Deploy core stack
  docker_stack:
    name: tradebot
    with_registry_auth: true
    resolve_image: never
    compose:
      - version: '3'
        services:
          traefik:
            container_name: "traefik"
            image: traefik:v2.3
            restart: unless-stopped
            environment:
              DO_AUTH_TOKEN: "{{ digitalocean_api_token }}"
            ports:
              - 80:80
              - 443:443
              - 8080:8080
            volumes:
              - /var/run/docker.sock:/var/run/docker.sock
              - /srv/traefik.toml:/etc/traefik/traefik.toml
              - /srv/acme:/etc/traefik/acme
            networks:
              - traefiknet
            deploy:
              placement:
                constraints:
                  - "node.role==manager"
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.dashboard.rule=Host(`traefik.0d.kz`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
                - "traefik.http.routers.dashboard.service=api@internal"
                - "traefik.http.routers.dashboard.middlewares=auth"
                - "traefik.http.routers.dashboard.entrypoints=websecure"
                - "traefik.http.routers.dashboard.tls.certresolver=tlsresolver"
                - "traefik.http.middlewares.auth.basicauth.users=test:$$apr1$$MOMEjVtn$$.10ydpv.z80xNBRsmha9S0"
                - "traefik.http.services.dummy-svc.loadbalancer.server.port=9999"
          whoami:
            image: traefik/whoami
            container_name: "whoami"
            ports:
              - 80:80
            networks:
              - traefiknet
            deploy:
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.whoami.rule=Host(`whoami.0d.kz`)"
                - "traefik.http.routers.whoami.entrypoints=websecure"
                - "traefik.http.routers.whoami.tls.certresolver=tlsresolver"
                - "traefik.http.services.whoami.loadbalancer.server.port=80"
        networks:
          traefiknet:
            external: true
